<div class="my-bookings-page container py-4 my-5">
  <!-- Header -->
  <div
    class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 gap-3"
  >
    <div>
      <h2 class="mb-1 my-bookings-title">My Bookings</h2>
      <p class="mb-0 text-muted">
        View and manage all your event tickets in one place.
      </p>
    </div>

    <!-- Filter Pills -->
    <div
      class="btn-group my-bookings-filters"
      role="group"
      aria-label="Booking filters"
    >
      <button
        type="button"
        class="btn btn-sm"
        [class.my-filter-active]="activeFilter === 'All'"
        (click)="setFilter('All')"
      >
        All
      </button>
      <button
        type="button"
        class="btn btn-sm"
        [class.my-filter-active]="activeFilter === 'Upcoming'"
        (click)="setFilter('Upcoming')"
      >
        Upcoming
      </button>
      <button
        type="button"
        class="btn btn-sm"
        [class.my-filter-active]="activeFilter === 'Completed'"
        (click)="setFilter('Completed')"
      >
        Completed
      </button>
    
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="summary-card card shadow-sm border-0">
        <div class="card-body d-flex flex-column">
          <span class="summary-label">Total Tickets</span>
          <span class="summary-value">{{ tickets.length }}</span>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="summary-card card shadow-sm border-0">
        <div class="card-body d-flex flex-column">
          <span class="summary-label">Upcoming</span>
          <span class="summary-value">
            {{ getStatusCount("Upcoming") }}
          </span>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="summary-card card shadow-sm border-0">
        <div class="card-body d-flex flex-column">
          <span class="summary-label">Completed</span>
          <span class="summary-value">
            {{ getStatusCount("Completed") }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tickets List -->
  <div *ngIf="!isLoading && filteredTickets.length > 0; else noTickets">
    <div
      class="ticket-card card mb-3"
      *ngFor="let ticket of filteredTickets"
    >
      <div class="card-body">
        <div
          class="d-flex flex-column flex-lg-row justify-content-between gap-3"
        >
          <!-- Left: Event details -->
          <div class="d-flex flex-column flex-md-row gap-3 flex-grow-1">
            <div class="ticket-date text-center px-3 py-2">
              <div class="ticket-day">
                {{ ticket.event?.date | date : "dd" }}
              </div>
              <div class="ticket-month">
                {{ ticket.event?.date | date : "MMM" }}
              </div>
              <div class="ticket-time">
                {{ (ticket.event?.st_Date | date : "hh:mm a") || 'Time TBA' }}
              </div>
            </div>

            <div>
              <h5 class="mb-1 ticket-event-name">
                {{ ticket.event?.name || 'Event Name' }}
              </h5>
              <p class="mb-1 text-muted ticket-venue">
                {{ ticket.event?.location || 'Venue' }} Â· {{ ticket.event?.city || 'City' }}
              </p>
              <p class="mb-1 ticket-type-info">
                {{ ticket.ticketType?.name || 'Ticket Type' }}
              </p>
              <p class="mb-0 ticket-code text-muted small">
                Ticket ID: <strong>{{ ticket.ticket_ID }}</strong>
              </p>
            </div>
          </div>

          <!-- Right: Status + actions -->
          <div
            class="d-flex flex-column align-items-lg-end justify-content-between flex-shrink-0"
          >
            <div class="mb-2">
              <span
                class="badge ticket-status-badge"
                [ngClass]="{
                  'status-upcoming': getTicketStatus(ticket).toLowerCase() === 'upcoming',
                  'status-completed': getTicketStatus(ticket).toLowerCase() === 'completed',
                  'status-cancelled': getTicketStatus(ticket).toLowerCase() === 'cancelled'
                }"
              >
                {{ getTicketStatus(ticket) }}
              </span>
            </div>

            <div class="text-lg-end">
              <div class="ticket-price mb-2">
                <span class="price-label">Price</span>
                <span class="price-value">
                  {{
                    ticket.ticketType?.price | currency : "EGP" : "symbol" : "1.0-0"
                  }}
                </span>
              </div>

              <div class="btn-group">
                <button
                  class="btn btn-sm my-btn-primary"
                  (click)="onViewTicket(ticket)"
                >
                  View Ticket
                </button>
                <button
                  *ngIf="getTicketStatus(ticket).toLowerCase() === 'upcoming'"
                  class="btn btn-sm btn-outline-danger"
                  (click)="onCancelTicket(ticket)"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="text-center py-5">
    <i class="fas fa-spinner fa-spin fa-3x text-muted"></i>
    <p class="text-muted mt-3">Loading your tickets...</p>
  </div>

  <!-- No tickets state -->
  <ng-template #noTickets>
    <div class="no-tickets card border-0 text-center p-4">
      <div class="card-body">
        <h5 class="mb-2">No tickets yet</h5>
        <p class="text-muted mb-3">
          You don't have any {{ activeFilter | lowercase }} tickets right now.
        </p>
      </div>
    </div>
  </ng-template>
</div>

<!-- Ticket Modal -->
<div class="modal fade" [class.show]="showTicketModal" [style.display]="showTicketModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ticket Details</h5>
        <button type="button" class="btn-close" (click)="closeTicketModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" *ngIf="selectedTicket">
        <div class="mb-3">
          <h6>{{ selectedTicket.event?.name }}</h6>
          <p class="text-muted mb-2">{{ selectedTicket.event?.date | date:'mediumDate' }}</p>
          <p class="mb-3">
            <strong>{{ selectedTicket.ticketType?.name }}</strong> -
            {{ selectedTicket.ticketType?.price | currency:'EGP':'symbol':'1.0-0' }}
          </p>
        </div>

        <div class="qr-code-container mb-3">
          <h6 class="mb-3">Scan QR Code for Entry</h6>
          <div *ngIf="selectedTicket.qR_Code; else noQrCode">
            <img [src]="selectedTicket.qR_Code" alt="Ticket QR Code" class="img-fluid qr-code-image" style="max-width: 200px; max-height: 200px;">
            <p class="text-muted small mt-2">
              Contains: Ticket #{{ selectedTicket.ticket_ID }} - {{ selectedTicket.ticketType?.name }}
            </p>
          </div>
          <ng-template #noQrCode>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              QR Code not available for this ticket.
            </div>
          </ng-template>
        </div>

        <div class="ticket-info">
          <p><strong>Ticket ID:</strong> {{ selectedTicket.ticket_ID }}</p>
          <p><strong>Status:</strong>
            <span class="badge"
                  [class]="getTicketStatus(selectedTicket).toLowerCase() === 'unused' ? 'bg-success' :
                           getTicketStatus(selectedTicket).toLowerCase() === 'used' ? 'bg-secondary' : 'bg-warning'">
              {{ getTicketStatus(selectedTicket) }}
            </span>
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeTicketModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showTicketModal" (click)="closeTicketModal()"></div>
